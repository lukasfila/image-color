let icons: IconData[] = JSON.parse('[{"styleId":"b-54","width":20,"height":20,"left":680,"top":486,"lastColor":"","lastUrl":""},{"styleId":"b-55","width":20,"height":20,"left":680,"top":486,"lastColor":"","lastUrl":""},{"styleId":"b-56","width":20,"height":20,"left":571,"top":483,"lastColor":"","lastUrl":""},{"styleId":"b-57","width":20,"height":20,"left":571,"top":483,"lastColor":"","lastUrl":""},{"styleId":"b-59","width":20,"height":20,"left":42,"top":485,"lastColor":"","lastUrl":""},{"styleId":"b-60","width":20,"height":20,"left":42,"top":485,"lastColor":"","lastUrl":""},{"styleId":"b-63","width":20,"height":20,"left":680,"top":486,"lastColor":"","lastUrl":""},{"styleId":"b-64","width":20,"height":20,"left":680,"top":486,"lastColor":"","lastUrl":""},{"styleId":"b-65","width":20,"height":20,"left":925,"top":168,"lastColor":"","lastUrl":""},{"styleId":"b-66","width":20,"height":20,"left":925,"top":168,"lastColor":"","lastUrl":""},{"styleId":"b-73","width":20,"height":20,"left":806,"top":459,"lastColor":"","lastUrl":""},{"styleId":"b-75","width":20,"height":20,"left":980,"top":21,"lastColor":"","lastUrl":""},{"styleId":"b-78","width":20,"height":20,"left":512,"top":462,"lastColor":"","lastUrl":""},{"styleId":"b-79","width":20,"height":20,"left":512,"top":462,"lastColor":"","lastUrl":""},{"styleId":"b-81","width":20,"height":20,"left":743,"top":486,"lastColor":"","lastUrl":""},{"styleId":"b-83","width":10,"height":10,"left":1072,"top":387,"lastColor":"","lastUrl":""},{"styleId":"b-84","width":20,"height":20,"left":441,"top":525,"lastColor":"","lastUrl":""},{"styleId":"b-85","width":20,"height":20,"left":441,"top":525,"lastColor":"","lastUrl":""},{"styleId":"b-98","width":10,"height":10,"left":1072,"top":343,"lastColor":"","lastUrl":""},{"styleId":"b-101","width":10,"height":10,"left":1072,"top":376,"lastColor":"","lastUrl":""},{"styleId":"b-105","width":12,"height":24,"left":883,"top":81,"lastColor":"","lastUrl":""},{"styleId":"b-106","width":30,"height":30,"left":124,"top":431,"color":"rgba(255, 255, 255, 0.75)","lastColor":"","lastUrl":""},{"styleId":"b-107","width":30,"height":30,"left":124,"top":431,"color":"rgba(255, 255, 255, 0.3)","lastColor":"","lastUrl":""},{"styleId":"b-108","width":30,"height":30,"left":124,"top":431,"color":"#ffffff","lastColor":"","lastUrl":""},{"styleId":"b-109","width":30,"height":30,"left":155,"top":431,"color":"rgba(255, 255, 255, 0.75)","lastColor":"","lastUrl":""},{"styleId":"b-110","width":30,"height":30,"left":155,"top":431,"color":"rgba(255, 255, 255, 0.3)","lastColor":"","lastUrl":""},{"styleId":"b-111","width":30,"height":30,"left":155,"top":431,"color":"#ffffff","lastColor":"","lastUrl":""},{"styleId":"b-112","width":30,"height":30,"left":186,"top":431,"color":"rgba(255, 255, 255, 0.75)","lastColor":"","lastUrl":""},{"styleId":"b-113","width":30,"height":30,"left":186,"top":431,"color":"rgba(255, 255, 255, 0.3)","lastColor":"","lastUrl":""},{"styleId":"b-114","width":30,"height":30,"left":186,"top":431,"color":"#ffffff","lastColor":"","lastUrl":""},{"styleId":"b-115","width":30,"height":30,"left":217,"top":431,"color":"rgba(255, 255, 255, 0.75)","lastColor":"","lastUrl":""},{"styleId":"b-116","width":30,"height":30,"left":217,"top":431,"color":"rgba(255, 255, 255, 0.3)","lastColor":"","lastUrl":""},{"styleId":"b-117","width":30,"height":30,"left":217,"top":431,"color":"#ffffff","lastColor":"","lastUrl":""},{"styleId":"b-118","width":20,"height":20,"left":979,"top":0,"lastColor":"","lastUrl":""},{"styleId":"b-119","width":20,"height":20,"left":979,"top":0,"lastColor":"","lastUrl":""},{"styleId":"b-120","width":20,"height":20,"left":1001,"top":84,"lastColor":"","lastUrl":""},{"styleId":"b-121","width":20,"height":20,"left":1001,"top":84,"lastColor":"","lastUrl":""},{"styleId":"b-125","width":20,"height":20,"left":938,"top":21,"lastColor":"","lastUrl":""},{"styleId":"b-126","width":20,"height":20,"left":938,"top":21,"lastColor":"","lastUrl":""},{"styleId":"b-127","width":20,"height":20,"left":938,"top":21,"lastColor":"","lastUrl":""},{"styleId":"b-141","width":20,"height":20,"left":938,"top":21,"lastColor":"","lastUrl":""},{"styleId":"b-144","width":20,"height":20,"left":1058,"top":525,"lastColor":"","lastUrl":""},{"styleId":"b-145","width":20,"height":20,"left":1043,"top":126,"lastColor":"","lastUrl":""},{"styleId":"b-146","width":20,"height":20,"left":1043,"top":147,"lastColor":"","lastUrl":""},{"styleId":"b-147","width":20,"height":20,"left":1043,"top":441,"lastColor":"","lastUrl":""},{"styleId":"b-148","width":20,"height":20,"left":1043,"top":462,"lastColor":"","lastUrl":""},{"styleId":"b-154","width":20,"height":20,"left":1058,"top":525,"lastColor":"","lastUrl":""},{"styleId":"b-155","width":20,"height":20,"left":1043,"top":126,"lastColor":"","lastUrl":""},{"styleId":"b-156","width":20,"height":20,"left":1043,"top":147,"lastColor":"","lastUrl":""},{"styleId":"b-157","width":20,"height":20,"left":1043,"top":441,"lastColor":"","lastUrl":""},{"styleId":"b-158","width":20,"height":20,"left":1043,"top":462,"lastColor":"","lastUrl":""},{"styleId":"b-160","width":20,"height":20,"left":938,"top":21,"lastColor":"","lastUrl":""},{"styleId":"b-161","width":10,"height":10,"left":1072,"top":343,"lastColor":"","lastUrl":""},{"styleId":"b-162","width":20,"height":20,"left":959,"top":42,"lastColor":"","lastUrl":""},{"styleId":"b-163","width":10,"height":10,"left":1072,"top":354,"lastColor":"","lastUrl":""},{"styleId":"b-164","width":20,"height":20,"left":959,"top":105,"lastColor":"","lastUrl":""},{"styleId":"b-166","width":20,"height":20,"left":575,"top":462,"lastColor":"","lastUrl":""},{"styleId":"b-168","width":20,"height":20,"left":1030,"top":231,"lastColor":"","lastUrl":""},{"styleId":"b-170","width":20,"height":20,"left":959,"top":420,"lastColor":"","lastUrl":""},{"styleId":"b-172","width":20,"height":20,"left":1009,"top":273,"lastColor":"","lastUrl":""},{"styleId":"b-198","width":20,"height":20,"left":1001,"top":42,"lastColor":"","lastUrl":""},{"styleId":"b-199","width":20,"height":20,"left":1001,"top":42,"color":"#f28918","lastColor":"","lastUrl":""},{"styleId":"b-200","width":20,"height":20,"left":1001,"top":42,"color":"#e34243","lastColor":"","lastUrl":""},{"styleId":"b-202","width":20,"height":20,"left":1009,"top":189,"lastColor":"","lastUrl":""},{"styleId":"b-204","width":20,"height":20,"left":1009,"top":168,"lastColor":"","lastUrl":""},{"styleId":"b-206","width":20,"height":20,"left":1009,"top":210,"lastColor":"","lastUrl":""},{"styleId":"b-208","width":20,"height":20,"left":1043,"top":483,"lastColor":"","lastUrl":""},{"styleId":"b-210","width":20,"height":20,"left":1043,"top":420,"lastColor":"","lastUrl":""},{"styleId":"b-212","width":20,"height":20,"left":1051,"top":168,"lastColor":"","lastUrl":""},{"styleId":"b-214","width":20,"height":20,"left":1051,"top":231,"lastColor":"","lastUrl":""},{"styleId":"b-224","width":20,"height":20,"left":959,"top":63,"lastColor":"","lastUrl":""},{"styleId":"b-225","width":20,"height":20,"left":959,"top":105,"lastColor":"","lastUrl":""},{"styleId":"b-226","width":20,"height":20,"left":980,"top":420,"lastColor":"","lastUrl":""},{"styleId":"b-227","width":20,"height":20,"left":980,"top":420,"lastColor":"","lastUrl":""},{"styleId":"b-228","width":20,"height":20,"left":980,"top":147,"lastColor":"","lastUrl":""},{"styleId":"b-229","width":20,"height":20,"left":980,"top":147,"lastColor":"","lastUrl":""},{"styleId":"b-232","width":20,"height":20,"left":946,"top":357,"lastColor":"","lastUrl":""},{"styleId":"b-234","width":20,"height":20,"left":946,"top":315,"lastColor":"","lastUrl":""},{"styleId":"b-236","width":20,"height":20,"left":946,"top":273,"lastColor":"","lastUrl":""},{"styleId":"b-238","width":20,"height":20,"left":946,"top":231,"lastColor":"","lastUrl":""},{"styleId":"b-239","width":20,"height":20,"left":980,"top":105,"lastColor":"","lastUrl":""},{"styleId":"b-240","width":20,"height":20,"left":980,"top":84,"lastColor":"","lastUrl":""},{"styleId":"b-241","width":20,"height":20,"left":980,"top":63,"lastColor":"","lastUrl":""},{"styleId":"b-244","width":20,"height":20,"left":1022,"top":42,"lastColor":"","lastUrl":""},{"styleId":"b-246","width":20,"height":20,"left":1022,"top":105,"lastColor":"","lastUrl":""},{"styleId":"b-248","width":20,"height":20,"left":1022,"top":420,"lastColor":"","lastUrl":""},{"styleId":"b-250","width":20,"height":20,"left":1022,"top":483,"lastColor":"","lastUrl":""},{"styleId":"b-252","width":20,"height":20,"left":1030,"top":168,"lastColor":"","lastUrl":""},{"styleId":"b-254","width":20,"height":20,"left":1030,"top":210,"lastColor":"","lastUrl":""},{"styleId":"b-255","width":20,"height":20,"left":1016,"top":525,"lastColor":"","lastUrl":""},{"styleId":"b-256","width":20,"height":20,"left":1016,"top":525,"lastColor":"","lastUrl":""},{"styleId":"b-292","width":20,"height":20,"left":959,"top":147,"lastColor":"","lastUrl":""},{"styleId":"b-293","width":20,"height":20,"left":575,"top":462,"lastColor":"","lastUrl":""},{"styleId":"b-297","width":20,"height":20,"left":252,"top":525,"lastColor":"","lastUrl":""},{"styleId":"b-299","width":20,"height":20,"left":294,"top":525,"lastColor":"","lastUrl":""},{"styleId":"b-302","width":20,"height":20,"left":386,"top":462,"lastColor":"","lastUrl":""},{"styleId":"b-304","width":20,"height":20,"left":767,"top":465,"lastColor":"","lastUrl":""},{"styleId":"b-751","width":20,"height":20,"left":919,"top":401,"lastColor":"","lastUrl":""},{"styleId":"b-752","width":20,"height":20,"left":904,"top":170,"lastColor":"","lastUrl":""},{"styleId":"b-756","width":20,"height":20,"left":917,"top":42,"lastColor":"","lastUrl":""},{"styleId":"b-758","width":20,"height":20,"left":917,"top":105,"lastColor":"","lastUrl":""},{"styleId":"b-760","width":20,"height":20,"left":917,"top":424,"lastColor":"","lastUrl":""},{"styleId":"b-761","width":20,"height":20,"left":743,"top":486,"lastColor":"","lastUrl":""},{"styleId":"b-762","width":20,"height":20,"left":743,"top":486,"lastColor":"","lastUrl":""},{"styleId":"b-767","width":20,"height":20,"left":959,"top":147,"lastColor":"","lastUrl":""},{"styleId":"b-770","width":20,"height":20,"left":917,"top":21,"lastColor":"","lastUrl":""},{"styleId":"b-771","width":20,"height":20,"left":917,"top":21,"lastColor":"","lastUrl":""},{"styleId":"b-772","width":20,"height":20,"left":925,"top":357,"lastColor":"","lastUrl":""},{"styleId":"b-774","width":20,"height":20,"left":925,"top":357,"lastColor":"","lastUrl":""},{"styleId":"b-783","width":16,"height":16,"left":697,"top":186,"lastColor":"","lastUrl":""},{"styleId":"b-784","width":16,"height":16,"left":1072,"top":315,"lastColor":"","lastUrl":""},{"styleId":"b-788","width":20,"height":20,"left":378,"top":504,"lastColor":"","lastUrl":""},{"styleId":"b-789","width":20,"height":20,"left":399,"top":504,"lastColor":"","lastUrl":""},{"styleId":"b-790","width":20,"height":20,"left":420,"top":504,"lastColor":"","lastUrl":""},{"styleId":"b-800","width":20,"height":20,"left":441,"top":504,"lastColor":"","lastUrl":""},{"styleId":"b-801","width":20,"height":20,"left":189,"top":504,"lastColor":"","lastUrl":""},{"styleId":"b-802","width":20,"height":20,"left":988,"top":168,"lastColor":"","lastUrl":""},{"styleId":"b-803","width":20,"height":20,"left":988,"top":189,"lastColor":"","lastUrl":""},{"styleId":"b-804","width":20,"height":20,"left":988,"top":231,"lastColor":"","lastUrl":""},{"styleId":"b-805","width":20,"height":20,"left":988,"top":252,"lastColor":"","lastUrl":""},{"styleId":"b-806","width":20,"height":20,"left":988,"top":273,"lastColor":"","lastUrl":""},{"styleId":"b-807","width":20,"height":20,"left":988,"top":294,"lastColor":"","lastUrl":""},{"styleId":"b-808","width":20,"height":20,"left":988,"top":357,"lastColor":"","lastUrl":""},{"styleId":"b-812","width":20,"height":20,"left":785,"top":501,"lastColor":"","lastUrl":""},{"styleId":"b-813","width":20,"height":20,"left":806,"top":501,"lastColor":"","lastUrl":""},{"styleId":"b-814","width":20,"height":20,"left":827,"top":501,"lastColor":"","lastUrl":""},{"styleId":"b-815","width":20,"height":20,"left":63,"top":504,"lastColor":"","lastUrl":""},{"styleId":"b-816","width":20,"height":20,"left":63,"top":504,"lastColor":"","lastUrl":""},{"styleId":"b-817","width":20,"height":20,"left":63,"top":504,"lastColor":"","lastUrl":""},{"styleId":"b-823","width":20,"height":20,"left":959,"top":462,"lastColor":"","lastUrl":""},{"styleId":"b-826","width":20,"height":20,"left":126,"top":504,"lastColor":"","lastUrl":""},{"styleId":"b-828","width":20,"height":20,"left":1009,"top":252,"lastColor":"","lastUrl":""},{"styleId":"b-829","width":20,"height":20,"left":917,"top":21,"lastColor":"","lastUrl":""},{"styleId":"b-830","width":20,"height":20,"left":925,"top":357,"lastColor":"","lastUrl":""},{"styleId":"b-831","width":20,"height":20,"left":743,"top":486,"lastColor":"","lastUrl":""},{"styleId":"b-832","width":20,"height":20,"left":743,"top":486,"lastColor":"","lastUrl":""},{"styleId":"b-833","width":20,"height":20,"left":1001,"top":147,"lastColor":"","lastUrl":""},{"styleId":"b-834","width":20,"height":20,"left":42,"top":485,"lastColor":"","lastUrl":""},{"styleId":"b-835","width":20,"height":20,"left":42,"top":485,"lastColor":"","lastUrl":""},{"styleId":"b-836","width":20,"height":20,"left":575,"top":462,"lastColor":"","lastUrl":""},{"styleId":"b-837","width":20,"height":20,"left":575,"top":462,"lastColor":"","lastUrl":""},{"styleId":"b-838","width":20,"height":20,"left":767,"top":465,"lastColor":"","lastUrl":""},{"styleId":"b-839","width":20,"height":20,"left":767,"top":465,"lastColor":"","lastUrl":""},{"styleId":"b-840","width":20,"height":20,"left":1064,"top":483,"lastColor":"","lastUrl":""},{"styleId":"b-841","width":20,"height":20,"left":1064,"top":483,"lastColor":"","lastUrl":""},{"styleId":"b-842","width":20,"height":20,"left":1051,"top":357,"lastColor":"","lastUrl":""},{"styleId":"b-843","width":20,"height":20,"left":1051,"top":357,"lastColor":"","lastUrl":""},{"styleId":"b-847","width":20,"height":20,"left":462,"top":525,"lastColor":"","lastUrl":""},{"styleId":"b-848","width":20,"height":20,"left":483,"top":525,"lastColor":"","lastUrl":""},{"styleId":"b-849","width":20,"height":20,"left":504,"top":525,"lastColor":"","lastUrl":""},{"styleId":"b-850","width":20,"height":20,"left":525,"top":525,"lastColor":"","lastUrl":""},{"styleId":"b-851","width":20,"height":20,"left":567,"top":525,"lastColor":"","lastUrl":""},{"styleId":"b-852","width":20,"height":20,"left":588,"top":525,"lastColor":"","lastUrl":""},{"styleId":"b-853","width":20,"height":20,"left":462,"top":525,"lastColor":"","lastUrl":""},{"styleId":"b-854","width":20,"height":20,"left":483,"top":525,"lastColor":"","lastUrl":""},{"styleId":"b-855","width":20,"height":20,"left":504,"top":525,"lastColor":"","lastUrl":""},{"styleId":"b-856","width":20,"height":20,"left":525,"top":525,"lastColor":"","lastUrl":""},{"styleId":"b-857","width":20,"height":20,"left":567,"top":525,"lastColor":"","lastUrl":""},{"styleId":"b-858","width":20,"height":20,"left":588,"top":525,"lastColor":"","lastUrl":""},{"styleId":"b-859","width":20,"height":20,"left":1009,"top":336,"lastColor":"","lastUrl":""},{"styleId":"b-860","width":20,"height":20,"left":655,"top":507,"lastColor":"","lastUrl":""},{"styleId":"b-861","width":20,"height":20,"left":655,"top":507,"lastColor":"","lastUrl":""},{"styleId":"b-862","width":20,"height":20,"left":21,"top":527,"lastColor":"","lastUrl":""},{"styleId":"b-863","width":20,"height":20,"left":21,"top":527,"lastColor":"","lastUrl":""},{"styleId":"b-865","width":20,"height":20,"left":953,"top":525,"lastColor":"","lastUrl":""},{"styleId":"b-866","width":20,"height":20,"left":974,"top":525,"lastColor":"","lastUrl":""}]');

type IconData = {
    styleId: string;
    width: number;
    height: number;
    left: number;
    top: number;
};

const colorStr = "#aa00aa";

const rgbaRegex = /\s*rgba\(\s*(\d{1,3})\s*,\s*(\d{1,3})\s*,\s*(\d{1,3})\s*,\s*(\d+|\d*\.\d+)\s*\)\s*/;


window.onload = () => {
    demo1();
    demo2();
}

/**
 * Separate BG images
 */

function demo1() {
    let start = new Date().getTime();
    let style = document.createElement("style");
    document.head.appendChild(style);

    let image = document.getElementById("image_source");

    let css = "";

    let data = "";
    for (let i = 0; i < icons.length; i++) {
        css += createStyle(image as HTMLImageElement, icons[i]!);
        data += render(icons[i]!);
    }

    style.appendChild(document.createTextNode(css));

    document.body.innerHTML += "<div id='demo1'>" + data + "</div>";
    console.log("demo1", new Date().getTime() - start);
}

function render(iconData: IconData) {
    return `<span class="${iconData.styleId}"></span>`;
}

function createStyle(image: HTMLImageElement, iconData: IconData) {
    let url = urlData(image, iconData);

    return `#demo1 .${iconData.styleId}{
        width: ${iconData.width}px;
        height: ${iconData.height}px;
        background-image: url(${url});
        display: inline-block;
        margin: 5px;
    }`;
}


function urlData(image: HTMLImageElement, iconData: IconData) {

    let width = iconData.width;
    let height = iconData.height;
    let left = iconData.left;
    let top = iconData.top;

    let canvas = document.createElement("canvas");
    canvas.width = width;
    canvas.height = height;
    let ctx = <CanvasRenderingContext2D>canvas.getContext("2d");
    ctx.drawImage(image, -left, -top);
    let imgData = ctx.getImageData(0, 0, width, height);
    let imgDataData = imgData.data;
    let rgba = rgbaRegex.exec(colorStr);
    let cRed: number, cGreen: number, cBlue: number, cAlpha: number;
    if (rgba) {
        cRed = parseInt(rgba[1]!, 10);
        cGreen = parseInt(rgba[2]!, 10);
        cBlue = parseInt(rgba[3]!, 10);
        cAlpha = Math.round(parseFloat(rgba[4]!) * 255);
    } else {
        cRed = parseInt(colorStr.substr(1, 2), 16);
        cGreen = parseInt(colorStr.substr(3, 2), 16);
        cBlue = parseInt(colorStr.substr(5, 2), 16);
        cAlpha = parseInt(colorStr.substr(7, 2), 16) || 0xff;
    }
    if (cAlpha === 0xff) {
        for (let i = 0; i < imgDataData.length; i += 4) {
            // Horrible workaround for imprecisions due to browsers using premultiplied alpha internally for canvas
            let red = imgDataData[i]!;
            if (
                red === imgDataData[i + 1] &&
                red === imgDataData[i + 2] &&
                (red === 0x80 || (imgDataData[i + 3]! < 0xff && red > 0x70))
            ) {
                imgDataData[i] = cRed;
                imgDataData[i + 1] = cGreen;
                imgDataData[i + 2] = cBlue;
            }
        }
    } else {
        for (let i = 0; i < imgDataData.length; i += 4) {
            let red = imgDataData[i]!;
            let alpha = imgDataData[i + 3]!;
            if (
                red === imgDataData[i + 1] &&
                red === imgDataData[i + 2] &&
                (red === 0x80 || (alpha < 0xff && red > 0x70))
            ) {
                if (alpha === 0xff) {
                    imgDataData[i] = cRed;
                    imgDataData[i + 1] = cGreen;
                    imgDataData[i + 2] = cBlue;
                    imgDataData[i + 3] = cAlpha;
                } else {
                    alpha = alpha * (1.0 / 255);
                    imgDataData[i] = Math.round(cRed * alpha);
                    imgDataData[i + 1] = Math.round(cGreen * alpha);
                    imgDataData[i + 2] = Math.round(cBlue * alpha);
                    imgDataData[i + 3] = Math.round(cAlpha * alpha);
                }
            }
        }
    }
    ctx.putImageData(imgData, 0, 0);
    return canvas.toDataURL();
}

/**
 * Single bg image
 */

function demo2() {
    let start = new Date().getTime();
    let style = document.createElement("style");
    document.head.appendChild(style);

    let image = document.getElementById("image_source");

    if (!image) {
        return;
    }

    let css = "";
    let data = "";

    let width = image.offsetWidth;
    let height = image.offsetHeight;
    let canvas = document.createElement("canvas");
    canvas.width = width;
    canvas.height = height;
    let ctx = <CanvasRenderingContext2D>canvas.getContext("2d");
    ctx.drawImage(image as HTMLImageElement, 0, 0);

    for (let i = 0; i < icons.length; i++) {
        urlData2(ctx, icons[i]!);
    }

    let urlData = canvas.toDataURL();

    css += createBgStyle(urlData);

    for (let i = 0; i < icons.length; i++) {
        css += createStyle2(icons[i]!);
        data += render(icons[i]!);
    }

    style.appendChild(document.createTextNode(css));

    document.body.innerHTML += "<div id='demo2'>" + data + "</div>";
    console.log("demo2", new Date().getTime() - start);
}

function createBgStyle(url: any) {
    return `:root{
        --image-bg: url(${url});
    }`;
}
function createStyle2(iconData: IconData) {
    return `#demo2 .${iconData.styleId}{
        width: ${iconData.width}px;
        height: ${iconData.height}px;
        background: var(--image-bg);
        background-position:-${iconData.left}px -${iconData.top}px;
        background-repeat: no-repeat;
        display: inline-block;
        margin: 5px;
    }`;
}

function urlData2(ctx: CanvasRenderingContext2D, iconData: IconData) {
    let width = iconData.width;
    let height = iconData.height;
    let left = iconData.left;
    let top = iconData.top;

    let imgData = ctx.getImageData(left, top, width, height);
    let imgDataData = imgData.data;
    let rgba = rgbaRegex.exec(colorStr);
    let cRed: number, cGreen: number, cBlue: number, cAlpha: number;
    if (rgba) {
        cRed = parseInt(rgba[1]!, 10);
        cGreen = parseInt(rgba[2]!, 10);
        cBlue = parseInt(rgba[3]!, 10);
        cAlpha = Math.round(parseFloat(rgba[4]!) * 255);
    } else {
        cRed = parseInt(colorStr.substr(1, 2), 16);
        cGreen = parseInt(colorStr.substr(3, 2), 16);
        cBlue = parseInt(colorStr.substr(5, 2), 16);
        cAlpha = parseInt(colorStr.substr(7, 2), 16) || 0xff;
    }
    if (cAlpha === 0xff) {
        for (let i = 0; i < imgDataData.length; i += 4) {
            // Horrible workaround for imprecisions due to browsers using premultiplied alpha internally for canvas
            let red = imgDataData[i]!;
            if (
                red === imgDataData[i + 1] &&
                red === imgDataData[i + 2] &&
                (red === 0x80 || (imgDataData[i + 3]! < 0xff && red > 0x70))
            ) {
                imgDataData[i] = cRed;
                imgDataData[i + 1] = cGreen;
                imgDataData[i + 2] = cBlue;
            }
        }
    } else {
        for (let i = 0; i < imgDataData.length; i += 4) {
            let red = imgDataData[i]!;
            let alpha = imgDataData[i + 3]!;
            if (
                red === imgDataData[i + 1] &&
                red === imgDataData[i + 2] &&
                (red === 0x80 || (alpha < 0xff && red > 0x70))
            ) {
                if (alpha === 0xff) {
                    imgDataData[i] = cRed;
                    imgDataData[i + 1] = cGreen;
                    imgDataData[i + 2] = cBlue;
                    imgDataData[i + 3] = cAlpha;
                } else {
                    alpha = alpha * (1.0 / 255);
                    imgDataData[i] = Math.round(cRed * alpha);
                    imgDataData[i + 1] = Math.round(cGreen * alpha);
                    imgDataData[i + 2] = Math.round(cBlue * alpha);
                    imgDataData[i + 3] = Math.round(cAlpha * alpha);
                }
            }
        }
    }
    ctx.putImageData(imgData, left, top);
}